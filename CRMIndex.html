<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Prospecção - Silva Tintas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para a barra de rolagem */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Transições suaves */
        .view {
            transition: opacity 0.5s ease-in-out;
        }
        .hidden-view {
            opacity: 0;
            pointer-events: none;
            position: absolute;
            width: 100%;
        }
        .visible-view {
            opacity: 1;
            position: relative;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Tela de Login -->
    <div id="login-view" class="view visible-view min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-sm bg-white p-8 rounded-xl shadow-lg">
            <div class="text-center mb-8">
                 <h1 class="text-3xl font-bold text-gray-700">Silva Tintas</h1>
                 <p class="text-gray-500">CRM de Prospecção</p>
            </div>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Login</label>
                    <input type="text" id="username" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                    <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">Entrar</button>
                <p id="login-error" class="text-red-500 text-sm text-center mt-4"></p>
            </form>
        </div>
    </div>

    <!-- Tela Principal do CRM -->
    <div id="crm-view" class="view hidden-view">
        <!-- Container Principal -->
        <div class="container mx-auto p-4 md:p-8">

            <!-- Cabeçalho -->
            <header class="flex flex-col md:flex-row justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-700">CRM Silva Tintas</h1>
                    <p id="welcome-message" class="text-gray-500">Bem-vindo!</p>
                </div>
                <div class="flex items-center space-x-4 mt-4 md:mt-0">
                    <div class="text-center">
                        <span id="client-count" class="text-2xl font-bold text-blue-600">0</span>
                        <p class="text-sm text-gray-500">Clientes</p>
                    </div>
                    <button id="add-client-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
                        + Adicionar Cliente
                    </button>
                    <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
                        Sair
                    </button>
                </div>
            </header>

            <!-- Dashboard do Admin -->
            <section id="admin-dashboard" class="mb-8 hidden">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">Dashboard do Administrador</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Card de Conversão -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="font-semibold text-gray-600">Taxa de Conversão</h3>
                        <p id="conversion-rate" class="text-3xl font-bold text-green-600 mt-2">0%</p>
                        <p class="text-sm text-gray-500">Clientes que se tornaram "Cliente"</p>
                    </div>
                    <!-- Card de Clientes por Categoria -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="font-semibold text-gray-600">Clientes por Categoria</h3>
                        <ul id="category-count" class="mt-2 space-y-1 text-sm text-gray-700"></ul>
                    </div>
                    <!-- Card de Segmento Mais Explorado -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="font-semibold text-gray-600">Segmento Mais Explorado</h3>
                        <p id="top-segment" class="text-3xl font-bold text-blue-600 mt-2">-</p>
                        <p class="text-sm text-gray-500">Categoria com mais clientes</p>
                    </div>
                </div>
            </section>
            
            <!-- Lista de Clientes -->
            <main id="client-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Cards dos clientes serão inseridos aqui -->
            </main>
        </div>
    </div>

    <!-- Modal para Adicionar/Editar Cliente -->
    <div id="client-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6">Adicionar Novo Cliente</h2>
            <form id="client-form">
                <div class="mb-4">
                    <label for="empresa" class="block text-sm font-medium text-gray-700 mb-1">Empresa*</label>
                    <input type="text" id="empresa" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="endereco" class="block text-sm font-medium text-gray-700 mb-1">Endereço*</label>
                    <input type="text" id="endereco" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="telefone" class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
                        <input type="tel" id="telefone" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="email" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="mb-4">
                    <label for="vendedor" class="block text-sm font-medium text-gray-700 mb-1">Vendedor Responsável*</label>
                    <input type="text" id="vendedor" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="categoria" class="block text-sm font-medium text-gray-700 mb-1">Categoria*</label>
                    <select id="categoria" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="Funilaria">Funilaria</option>
                        <option value="Madeireira">Madeireira</option>
                        <option value="Industria">Indústria</option>
                        <option value="Veiculos Pesados">Veículos Pesados</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">Cancelar</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Salvar Cliente</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // =====================================================================================
        // NOTA IMPORTANTE SOBRE O ERRO "Missing or insufficient permissions"
        // =====================================================================================
        // Este erro acontece porque as regras de segurança padrão do seu banco de dados
        // Firestore não permitem que a aplicação leia ou escreva dados.
        //
        // PARA CORRIGIR:
        // 1. Vá para o seu projeto no Firebase Console (https://console.firebase.google.com/).
        // 2. No menu à esquerda, vá para "Build" -> "Firestore Database".
        // 3. Clique na aba "Regras" (Rules) na parte superior.
        // 4. Substitua todo o conteúdo pelo código abaixo e clique em "Publicar".
        //
        // ---- COPIE E COLE ESTAS REGRAS NO SEU FIREBASE ----
        //
        // rules_version = '2';
        // service cloud.firestore {
        //   match /databases/{database}/documents {
        //     // Permite que qualquer usuário autenticado (incluindo anônimo)
        //     // leia e escreva na coleção 'clientes'.
        //     match /clientes/{clienteId} {
        //       allow read, write: if request.auth != null;
        //     }
        //   }
        // }
        //
        // =====================================================================================

        // --- Configuração e Inicialização ---
        // CORREÇÃO: As chaves do seu projeto Firebase foram atualizadas.
        const firebaseConfig = {
            apiKey: "AIzaSyDPisgGzruxqnXzf9hPlb05uCN3hMozt2s",
            authDomain: "crm-silva-tintas.firebaseapp.com",
            projectId: "crm-silva-tintas",
            storageBucket: "crm-silva-tintas.firebasestorage.app",
            messagingSenderId: "37152653096",
            appId: "1:37152653096:web:37e27f33544fdc36abda1d",
            measurementId: "G-Y4EXZKNN2F"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Variáveis de Estado ---
        let currentUserId = null;
        let currentUserRole = null; // 'Admin' ou 'Vendas'
        let unsubscribeFromClients = null; // Para parar de ouvir o snapshot no logout

        // --- Elementos do DOM ---
        const loginView = document.getElementById('login-view');
        const crmView = document.getElementById('crm-view');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const welcomeMessage = document.getElementById('welcome-message');
        const adminDashboard = document.getElementById('admin-dashboard');
        const clientList = document.getElementById('client-list');
        const clientCount = document.getElementById('client-count');
        const addClientBtn = document.getElementById('add-client-btn');
        const clientModal = document.getElementById('client-modal');
        const cancelBtn = document.getElementById('cancel-btn');
        const clientForm = document.getElementById('client-form');

        // --- Lógica de Autenticação e Login ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                console.log("Firebase Auth está pronto. User ID:", currentUserId);
                loginError.textContent = ""; 
            } else {
                try {
                    loginError.textContent = "Conectando...";
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Falha ao conectar com o Firebase:", error);
                    loginError.textContent = "Erro de conexão. Verifique a internet.";
                }
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            if (!currentUserId) {
                loginError.textContent = 'Aguardando conexão... Tente novamente em um instante.';
                return; 
            }

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if ((username === 'Admin' && password === 'Admin') || (username === 'Vendas' && password === 'Vendas')) {
                currentUserRole = (username === 'Admin') ? 'Admin' : 'Vendas';
                showCrmView();
                listenToClients();
            } else {
                loginError.textContent = 'Login ou senha inválidos.';
            }
        });

        logoutBtn.addEventListener('click', () => {
            currentUserRole = null;
            loginError.textContent = '';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';

            if (unsubscribeFromClients) {
                unsubscribeFromClients();
            }
            
            showLoginView();
        });

        function showCrmView() {
            loginView.classList.remove('visible-view');
            loginView.classList.add('hidden-view');
            crmView.classList.remove('hidden-view');
            crmView.classList.add('visible-view');
            
            welcomeMessage.textContent = `Bem-vindo, ${currentUserRole}!`;

            if (currentUserRole === 'Admin') {
                adminDashboard.classList.remove('hidden');
            } else {
                adminDashboard.classList.add('hidden');
            }
        }

        function showLoginView() {
            crmView.classList.remove('visible-view');
            crmView.classList.add('hidden-view');
            loginView.classList.remove('hidden-view');
            loginView.classList.add('visible-view');
        }

        // --- Lógica do Firestore ---
        const clientsCollectionRef = collection(db, 'clientes');

        function listenToClients() {
            if (unsubscribeFromClients) {
                unsubscribeFromClients(); 
            }
            unsubscribeFromClients = onSnapshot(clientsCollectionRef, (snapshot) => {
                const allClients = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const criadoEm = data.criadoEm && data.criadoEm.toDate ? data.criadoEm.toDate() : new Date();
                    return { id: doc.id, ...data, criadoEmDate: criadoEm };
                });
                
                allClients.sort((a, b) => b.criadoEmDate - a.criadoEmDate);

                renderClientList(allClients);
                
                if (currentUserRole === 'Admin') {
                    renderAdminDashboard(allClients);
                }
            }, (error) => {
                console.error("Erro ao buscar clientes:", error);
                clientList.innerHTML = `<p class="text-red-500 col-span-full text-center">Erro ao carregar dados. Verifique as regras de segurança do Firestore no seu painel Firebase.</p>`;
            });
        }

        // --- Renderização ---
        function renderClientList(clients) {
            clientList.innerHTML = '';
            clientCount.textContent = clients.length;

            if (clients.length === 0) {
                clientList.innerHTML = `<p class="text-gray-500 col-span-full text-center">Nenhum cliente cadastrado.</p>`;
                return;
            }

            clients.forEach(client => {
                const clientCard = createClientCard(client.id, client);
                clientList.appendChild(clientCard);
            });
        }

        function renderAdminDashboard(clients) {
            const totalClients = clients.length;
            if (totalClients === 0) {
                document.getElementById('conversion-rate').textContent = '0%';
                document.getElementById('category-count').innerHTML = '<li>Nenhum cliente</li>';
                document.getElementById('top-segment').textContent = '-';
                return;
            }

            const convertedClients = clients.filter(c => c.status === 'Cliente').length;
            const conversionRate = (convertedClients / totalClients) * 100;
            document.getElementById('conversion-rate').textContent = `${conversionRate.toFixed(1)}%`;

            const categoryCount = clients.reduce((acc, client) => {
                acc[client.categoria] = (acc[client.categoria] || 0) + 1;
                return acc;
            }, {});

            const categoryListEl = document.getElementById('category-count');
            categoryListEl.innerHTML = '';
            Object.entries(categoryCount).sort(([,a],[,b]) => b-a).forEach(([category, count]) => {
                const li = document.createElement('li');
                li.className = "flex justify-between";
                li.innerHTML = `<span>${category}</span> <span class="font-bold">${count}</span>`;
                categoryListEl.appendChild(li);
            });

            const topSegment = Object.keys(categoryCount).length > 0 ? Object.keys(categoryCount).reduce((a, b) => categoryCount[a] > categoryCount[b] ? a : b) : '-';
            document.getElementById('top-segment').textContent = topSegment;
        }

        // --- Lógica do Modal de Cliente ---
        addClientBtn.addEventListener('click', () => clientModal.classList.remove('hidden'));
        cancelBtn.addEventListener('click', () => clientModal.classList.add('hidden'));
        clientModal.addEventListener('click', (e) => {
            if (e.target === clientModal) clientModal.classList.add('hidden');
        });

        // --- CRUD (Create, Update, Delete) ---
        clientForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newClient = {
                empresa: document.getElementById('empresa').value.trim(),
                endereco: document.getElementById('endereco').value.trim(),
                telefone: document.getElementById('telefone').value.trim(),
                email: document.getElementById('email').value.trim(),
                vendedor: document.getElementById('vendedor').value.trim(),
                categoria: document.getElementById('categoria').value,
                status: 'Não contatado',
                criadoEm: new Date(),
                criadoPor: currentUserId
            };
            try {
                await addDoc(clientsCollectionRef, newClient);
                clientModal.classList.add('hidden');
                clientForm.reset();
            } catch (error) {
                console.error("Erro ao adicionar cliente:", error);
            }
        });

        async function updateClientStatus(id, newStatus) {
            const clientDocRef = doc(db, 'clientes', id);
            await updateDoc(clientDocRef, { status: newStatus });
        }

        async function deleteClient(id) {
            const clientDocRef = doc(db, 'clientes', id);
            await deleteDoc(clientDocRef);
        }

        // --- Criação do Card do Cliente (UI) ---
        function createClientCard(id, data) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-md p-5 flex flex-col justify-between transition-transform transform hover:-translate-y-1';
            
            const categoryColors = { 'Funilaria': 'bg-purple-100 text-purple-800', 'Madeireira': 'bg-yellow-100 text-yellow-800', 'Industria': 'bg-red-100 text-red-800', 'Veiculos Pesados': 'bg-gray-200 text-gray-800', 'Outro': 'bg-blue-100 text-blue-800' };
            const statusColors = { 'Não contatado': 'bg-gray-200 text-gray-800', 'Contatado': 'bg-blue-200 text-blue-800', 'Em negociação': 'bg-yellow-200 text-yellow-800', 'Cliente': 'bg-green-200 text-green-800' };
            const statusOptions = ['Não contatado', 'Contatado', 'Em negociação', 'Cliente'];

            card.innerHTML = `
                <div>
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="text-lg font-bold text-gray-900 pr-2">${data.empresa}</h3>
                        <span class="text-xs font-semibold px-2 py-1 rounded-full ${categoryColors[data.categoria] || 'bg-gray-100'}">${data.categoria}</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-1"><span class="font-semibold">Endereço:</span> ${data.endereco}</p>
                    ${data.telefone ? `<p class="text-sm text-gray-600 mb-1"><span class="font-semibold">Telefone:</span> ${data.telefone}</p>` : ''}
                    ${data.email ? `<p class="text-sm text-gray-600 mb-1"><span class="font-semibold">Email:</span> ${data.email}</p>` : ''}
                    <p class="text-sm text-gray-600 mb-4"><span class="font-semibold">Vendedor:</span> ${data.vendedor}</p>
                </div>
                <div class="mt-auto pt-4 border-t border-gray-200">
                    <div class="flex justify-between items-center">
                         <select class="status-select w-full text-sm font-semibold p-2 rounded-md border-gray-300 focus:ring-blue-500 focus:border-blue-500 ${statusColors[data.status]}">
                            ${statusOptions.map(opt => `<option value="${opt}" ${opt === data.status ? 'selected' : ''}>${opt}</option>`).join('')}
                        </select>
                        <button class="delete-btn text-gray-400 hover:text-red-600 transition duration-300 ml-3 flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            
            card.querySelector('.status-select').addEventListener('change', (e) => updateClientStatus(id, e.target.value));
            card.querySelector('.delete-btn').addEventListener('click', () => deleteClient(id));

            return card;
        }

    </script>
</body>
</html>
